const scriptName = "ë„ë°•";

let players = {};
let rankings = [];

const DAILY_BONUS = 100;
const POVERTY_THRESHOLD = 100;
const POVERTY_SUPPORT = 1000;

function response(room, msg, sender, isGroupChat, replier, imageDB, packageName) {
    let commands = msg.split(" ");
    
    if (!players[sender]) {
        players[sender] = { balance: 1000 };
    }

    switch(commands[0]) {
        case "!ìŠ¬ë¡¯":
            playSlot(commands, sender, replier);
            break;
        case "!ë¸”ë™ì­":
            playBlackjack(commands, sender, replier);
            break;
        case "!ë£°ë ›":
            playRoulette(commands, sender, replier);
            break;
        case "!ì”ì•¡":
            checkBalance(sender, replier);
            break;
        case "!ë­í‚¹":
            showRankings(replier);
            break;
        case "!ë„ë°•ë„ì›€ë§":
            showHelp(replier);
            break;
      case "!ì¼ì¼ë³´ë„ˆìŠ¤":
            claimDailyBonus(sender, replier);
            break;
        case "!ì§€ì›ê¸ˆ":
            claimPovertySupport(sender, replier);
            break;
    }
}

function playSlot(commands, sender, replier) {
    if (commands.length !== 2) {
        replier.reply("ì‚¬ìš©ë²•: !ìŠ¬ë¡¯ [ë² íŒ…ê¸ˆì•¡]");
        return;
    }
    
    let bet = parseInt(commands[1]);
    
    if (isNaN(bet) || bet <= 0 || players[sender].balance < bet) {
        replier.reply("ì˜¬ë°”ë¥¸ ë² íŒ… ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. í˜„ì¬ ì”ì•¡: " + players[sender].balance);
        return;
    }
    
    let symbols = ["ğŸ’", "ğŸ‹", "ğŸŠ", "ğŸ‡", "ğŸ””", "ğŸ’"];
    let result = [
        symbols[Math.floor(Math.random() * symbols.length)],
        symbols[Math.floor(Math.random() * symbols.length)],
        symbols[Math.floor(Math.random() * symbols.length)]
    ];
    
    let message = "[ " + result.join(" | ") + " ]\n";
    
    if (result[0] === result[1] && result[1] === result[2]) {
        let winnings = bet * getMultiplier(result[0]);
        players[sender].balance += winnings - bet;
        message += "ëŒ€ë°•! " + winnings + "ì„ íšë“í–ˆìŠµë‹ˆë‹¤!";
    } else if (result[0] === result[1] || result[1] === result[2]) {
        let winnings = Math.floor(bet * 1.5);
        players[sender].balance += winnings - bet;
        message += "ì†Œì†Œí•œ ìŠ¹ë¦¬! " + winnings + "ì„ íšë“í–ˆìŠµë‹ˆë‹¤.";
    } else {
        players[sender].balance -= bet;
        message += "ì•„ì‰½ë„¤ìš”. ë‹¤ìŒ ê¸°íšŒì—!";
    }
    
    message += "\ní˜„ì¬ ì”ì•¡: " + players[sender].balance;
    replier.reply(message);
    
    updateRankings();
}

function getMultiplier(symbol) {
    switch(symbol) {
        case "ğŸ’": return 2;
        case "ğŸ‹": return 3;
        case "ğŸŠ": return 4;
        case "ğŸ‡": return 5;
        case "ğŸ””": return 10;
        case "ğŸ’": return 20;
        default: return 1;
    }
}

function playBlackjack(commands, sender, replier) {
    if (commands.length !== 2) {
        replier.reply("ì‚¬ìš©ë²•: !ë¸”ë™ì­ [ë² íŒ…ê¸ˆì•¡]");
        return;
    }
    
    let bet = parseInt(commands[1]);
    
    if (isNaN(bet) || bet <= 0 || players[sender].balance < bet) {
        replier.reply("ì˜¬ë°”ë¥¸ ë² íŒ… ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. í˜„ì¬ ì”ì•¡: " + players[sender].balance);
        return;
    }
    
    let deck = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
    let playerHand = [deck[Math.floor(Math.random() * deck.length)], deck[Math.floor(Math.random() * deck.length)]];
    let dealerHand = [deck[Math.floor(Math.random() * deck.length)], deck[Math.floor(Math.random() * deck.length)]];
    
    let playerScore = calculateScore(playerHand);
    let dealerScore = calculateScore(dealerHand);
    
    let message = "ë‹¹ì‹ ì˜ íŒ¨: " + playerHand.join(", ") + " (ì ìˆ˜: " + playerScore + ")\n";
    message += "ë”œëŸ¬ì˜ íŒ¨: " + dealerHand[0] + ", ?\n";
    
    if (playerScore === 21) {
        players[sender].balance += Math.floor(bet * 1.5);
        message += "ë¸”ë™ì­! ë‹¹ì‹ ì´ ì´ê²¼ìŠµë‹ˆë‹¤. +" + Math.floor(bet * 1.5);
    } else if (dealerScore === 21) {
        players[sender].balance -= bet;
        message += "ë”œëŸ¬ ë¸”ë™ì­. ë‹¹ì‹ ì´ ì¡ŒìŠµë‹ˆë‹¤. -" + bet;
    } else {
        while (playerScore < 17) {
            playerHand.push(deck[Math.floor(Math.random() * deck.length)]);
            playerScore = calculateScore(playerHand);
        }
        
        while (dealerScore < 17) {
            dealerHand.push(deck[Math.floor(Math.random() * deck.length)]);
            dealerScore = calculateScore(dealerHand);
        }
        
        message += "ìµœì¢… ê²°ê³¼:\n";
        message += "ë‹¹ì‹ ì˜ íŒ¨: " + playerHand.join(", ") + " (ì ìˆ˜: " + playerScore + ")\n";
        message += "ë”œëŸ¬ì˜ íŒ¨: " + dealerHand.join(", ") + " (ì ìˆ˜: " + dealerScore + ")\n";
        
        if (playerScore > 21) {
            players[sender].balance -= bet;
            message += "ë²„ìŠ¤íŠ¸! ë‹¹ì‹ ì´ ì¡ŒìŠµë‹ˆë‹¤. -" + bet;
        } else if (dealerScore > 21 || playerScore > dealerScore) {
            players[sender].balance += bet;
            message += "ë‹¹ì‹ ì´ ì´ê²¼ìŠµë‹ˆë‹¤! +" + bet;
        } else if (playerScore < dealerScore) {
            players[sender].balance -= bet;
            message += "ë‹¹ì‹ ì´ ì¡ŒìŠµë‹ˆë‹¤. -" + bet;
        } else {
            message += "ë¬´ìŠ¹ë¶€ì…ë‹ˆë‹¤.";
        }
    }
    
    message += "\ní˜„ì¬ ì”ì•¡: " + players[sender].balance;
    replier.reply(message);
    
    updateRankings();
}

function calculateScore(hand) {
    let score = 0;
    let aceCount = 0;
    for (let card of hand) {
        if (card === 'A') {
            aceCount++;
            score += 11;
        } else if (['J', 'Q', 'K'].includes(card)) {
            score += 10;
        } else {
            score += parseInt(card);
        }
    }
    while (score > 21 && aceCount > 0) {
        score -= 10;
        aceCount--;
    }
    return score;
}

function playRoulette(commands, sender, replier) {
    if (commands.length !== 3) {
        replier.reply("ì‚¬ìš©ë²•: !ë£°ë › [ë² íŒ…ìœ í˜•] [ë² íŒ…ê¸ˆì•¡]\në² íŒ…ìœ í˜•: ë¹¨ê°•, ê²€ì •, í™€ìˆ˜, ì§ìˆ˜, 1-18, 19-36");
        return;
    }
    
    let betType = commands[1];
    let bet = parseInt(commands[2]);
    
    if (isNaN(bet) || bet <= 0 || players[sender].balance < bet) {
        replier.reply("ì˜¬ë°”ë¥¸ ë² íŒ… ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. í˜„ì¬ ì”ì•¡: " + players[sender].balance);
        return;
    }
    
    let result = Math.floor(Math.random() * 37);
    let isRed = [1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36].includes(result);
    let isOdd = result % 2 === 1;
    let isLow = result >= 1 && result <= 18;
    
    let message = "ê²°ê³¼: " + result + " (" + (isRed ? "ë¹¨ê°•" : "ê²€ì •") + ", " + (isOdd ? "í™€ìˆ˜" : "ì§ìˆ˜") + ", " + (isLow ? "1-18" : "19-36") + ")\n";
    
    let won = false;
    if ((betType === "ë¹¨ê°•" && isRed) || 
        (betType === "ê²€ì •" && !isRed && result !== 0) ||
        (betType === "í™€ìˆ˜" && isOdd) ||
        (betType === "ì§ìˆ˜" && !isOdd && result !== 0) ||
        (betType === "1-18" && isLow) ||
        (betType === "19-36" && !isLow && result !== 0)) {
        won = true;
    }
    
    if (won) {
        players[sender].balance += bet;
        message += "ì¶•í•˜í•©ë‹ˆë‹¤! ë‹¹ì‹ ì´ ì´ê²¼ìŠµë‹ˆë‹¤. +" + bet;
    } else {
        players[sender].balance -= bet;
        message += "ì•„ì‰½ë„¤ìš”. ë‹¹ì‹ ì´ ì¡ŒìŠµë‹ˆë‹¤. -" + bet;
    }
    
    message += "\ní˜„ì¬ ì”ì•¡: " + players[sender].balance;
    replier.reply(message);
    
    updateRankings();
}

function checkBalance(sender, replier) {
    replier.reply(sender + "ë‹˜ì˜ í˜„ì¬ ì”ì•¡: " + players[sender].balance);
}

function updateRankings() {
    rankings = Object.entries(players)
        .sort((a, b) => b[1].balance - a[1].balance)
        .slice(0, 5);
}

function claimDailyBonus(sender, replier) {
    if (!players[sender].lastBonusDate || isNewDay(players[sender].lastBonusDate)) {
        players[sender].balance += DAILY_BONUS;
        players[sender].lastBonusDate = new Date().toISOString();
        replier.reply(sender + "ë‹˜, ì¼ì¼ ë³´ë„ˆìŠ¤ " + DAILY_BONUS + "ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤. í˜„ì¬ ì”ì•¡: " + players[sender].balance);
    } else {
        replier.reply(sender + "ë‹˜, ì¼ì¼ ë³´ë„ˆìŠ¤ëŠ” í•˜ë£¨ì— í•œ ë²ˆë§Œ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
    }
}

function claimPovertySupport(sender, replier) {
    if (players[sender].balance <= POVERTY_THRESHOLD) {
        players[sender].balance += POVERTY_SUPPORT;
        replier.reply(sender + "ë‹˜, ì§€ì›ê¸ˆ " + POVERTY_SUPPORT + "ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤. í˜„ì¬ ì”ì•¡: " + players[sender].balance);
    } else {
        replier.reply(sender + "ë‹˜, ì§€ì›ê¸ˆì€ ì”ì•¡ì´ " + POVERTY_THRESHOLD + " ì´í•˜ì¼ ë•Œë§Œ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
    }
}

function showRankings(replier) {
    let message = "=== ìƒìœ„ 5ëª… ë­í‚¹ ===\n";
    rankings.forEach((player, index) => {
        message += (index + 1) + ". " + player[0] + ": " + player[1].balance + "\n";
    });
    replier.reply(message);
}
// ìƒˆë¡œ ì¶”ê°€ëœ í¬ì»¤ì™€ ë°”ì¹´ë¼ í•¨ìˆ˜ë“¤ì€ ê·¸ëŒ€ë¡œ ìœ ì§€

function showHelp(replier) {
    let helpMessage = "=== ì¢…í•© ì¹´ì§€ë…¸ ê²Œì„ ë„ì›€ë§ ===\n" +
        "!ìŠ¬ë¡¯ [ë² íŒ…ê¸ˆì•¡]: ìŠ¬ë¡¯ ë¨¸ì‹  í”Œë ˆì´\n" +
        "!ë¸”ë™ì­ [ë² íŒ…ê¸ˆì•¡]: ë¸”ë™ì­ í”Œë ˆì´\n" +
        "!ë£°ë › [ë² íŒ…ìœ í˜•] [ë² íŒ…ê¸ˆì•¡]: ë£°ë › í”Œë ˆì´\n" +
        "!ì”ì•¡: í˜„ì¬ ì”ì•¡ í™•ì¸\n" +
        "!ë­í‚¹: ìƒìœ„ 5ëª… ë­í‚¹ í™•ì¸\n" +
        "!ë„ë°•ë„ì›€ë§: ì´ ë„ì›€ë§ ë³´ê¸°\n" +
        "!ì§€ì›ê¸ˆ : ì§€ì›ê¸ˆì„ ë°›ìŠµë‹ˆë‹¤.\n" +
        "!ì¼ì¼ë³´ë„ˆìŠ¤: ì¼ì¼ë³´ë„ˆìŠ¤ ëˆì„ ë°›ìŠµë‹ˆë‹¤.";
    replier.reply(helpMessage);
}
