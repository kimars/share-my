var Game = {
  score: 0,
  timeLeft: 120,
  timer: null,
  weapon: { name: "ë§¨ì†", damage: 1 },
  ghosts: [
    { name: "ì¼ë°˜ ìœ ë ¹", emoji: "ğŸ‘»", hp: 3, points: 10 },
    { name: "í˜¸ë°• ìœ ë ¹", emoji: "ğŸƒ", hp: 5, points: 20 },
    { name: "í•´ê³¨ ìœ ë ¹", emoji: "ğŸ’€", hp: 7, points: 30 },
    { name: "ë°•ì¥ ìœ ë ¹", emoji: "ğŸ¦‡", hp: 2, points: 15 },
    { name: "ì•…ë§ˆ ìœ ë ¹", emoji: "ğŸ‘¿", hp: 10, points: 50 },
    { name: "ìœ ë ¹ ê³ ì–‘ì´", emoji: "ğŸˆâ€â¬›", hp: 4, points: 25 },
    { name: "ì¢€ë¹„", emoji: "ğŸ§Ÿ", hp: 8, points: 40 },
    { name: "ëŠ‘ëŒ€ì¸ê°„", emoji: "ğŸº", hp: 12, points: 60 },
    { name: "ë§ˆë…€", emoji: "ğŸ§™â€â™€ï¸", hp: 6, points: 35 },
    { name: "ë±€íŒŒì´ì–´", emoji: "ğŸ§›", hp: 9, points: 45 },
    { name: "í”„ë‘ì¼„ìŠˆíƒ€ì¸", emoji: "ğŸ§Ÿâ€â™‚ï¸", hp: 15, points: 70 },
    { name: "ìœ ë ¹ í”¼ì—ë¡œ", emoji: "ğŸ¤¡", hp: 5, points: 30 },
    { name: "ìœ ë ¹ ì™¸ê³„ì¸", emoji: "ğŸ‘½", hp: 7, points: 40 },
    { name: "ìœ ë ¹ ë¡œë´‡", emoji: "ğŸ¤–", hp: 10, points: 55 },
    { name: "ìœ ë ¹ í•´ì ", emoji: "ğŸ´â€â˜ ï¸", hp: 8, points: 45 },
    { name: "ìœ ë ¹ ë‹Œì", emoji: "ğŸ¥·", hp: 6, points: 35 },
    { name: "ìœ ë ¹ ë“œë˜ê³¤", emoji: "ğŸ‰", hp: 20, points: 100 },
    { name: "ìœ ë ¹ ìœ ë‹ˆì½˜", emoji: "ğŸ¦„", hp: 8, points: 50 },
    { name: "ìœ ë ¹ ì¸ì–´", emoji: "ğŸ§œâ€â™€ï¸", hp: 7, points: 40 },
    { name: "ìœ ë ¹ ìš”ì •", emoji: "ğŸ§š", hp: 3, points: 20 }
  ],
  
  bosses: [
    { name: "ëŒ€ì•…ë§ˆ", emoji: "ğŸ‘¹", hp: 50, points: 250 },
    { name: "ìœ ë ¹ì™•", emoji:"ğŸ‘‘" , hp :75 , points :350},
    { name : "ì§€ì˜¥ì˜ ë¬¸ì§€ê¸°" , emoji : "ğŸ”¥" , hp :100 , points :500}
   ],
  
   prefixes : ["í™”ë‚œ" , "ìŠ¬í”ˆ" , "ì¦ê±°ìš´" , "ì¡¸ë¦°" , 
               "ë°°ê³ í”ˆ" , "í¥ë¶„í•œ" , 
               "ì§€ë£¨í•œ" , 
               "ë†€ë€" , 
               "ê²ì— ì§ˆë¦°" , 
               "í˜¼ë€ìŠ¤ëŸ¬ìš´"],
  
   currentGhost : null,
   bossSpawned : false,
  
   start : function() {
     this.score =0;
     this.timeLeft =120;
     this.weapon = {name:"ë§¨ì†" , damage :1};
     this.bossSpawned = false;
     this.updateScore();
     this.updateTime();
     this.timer = setInterval(this.tick.bind(this),1000);
     this.spawnGhost();
   },

   tick : function() {
     this.timeLeft--;
     this.updateTime();
     if (this.timeLeft <=0) {
       this.end();
     } else if (this.timeLeft ===30 && !this.bossSpawned) {
       this.spawnBoss();
     }
   },

   end : function() {
     clearInterval(this.timer);
     replier.reply("ê²Œì„ ì¢…ë£Œ! ìµœì¢… ì ìˆ˜:" + this.score);
   },

   updateScore : function() {
     replier.reply("í˜„ì¬ ì ìˆ˜:" + this.score + "| ë¬´ê¸°:" + this.weapon.name);
   },

   updateTime : function() {
     replier.reply("ë‚¨ì€ ì‹œê°„:" + this.timeLeft + "ì´ˆ");
   },

   spawnGhost : function() {
     var ghost = this.ghosts[Math.floor(Math.random() * this.ghosts.length)];
     var prefix = this.prefixes[Math.floor(Math.random() * this.prefixes.length)];
     this.currentGhost = {
       name : prefix + "" + ghost.name,
       emoji : ghost.emoji,
       hp : ghost.hp,
       points : ghost.points
     };
     replier.reply(this.currentGhost.emoji + "" + this.currentGhost.name + "(HP:" + this.currentGhost.hp + ") 'ê³µê²©'ì´ë¼ê³  ì…ë ¥í•˜ì„¸ìš”!");
   },

   spawnBoss : function() {
     var boss = this.bosses[Math.floor(Math.random() * this.bosses.length)];
     this.currentGhost = boss;
     this.bossSpawned = true;
     replier.reply("âš ï¸ ë³´ìŠ¤ ì¶œí˜„ âš ï¸\n" + boss.emoji + "" + boss.name + "(HP:" + boss.hp + ") 'ê³µê²©'ì´ë¼ê³  ì…ë ¥í•˜ì„¸ìš”!");
   },

   attack : function() {
     if (!this.currentGhost) return;

     this.currentGhost.hp -= this.weapon.damage;
     replier.reply(this.weapon.name + "" + this.weapon.damage + 
                   'ë°ë¯¸ì§€ë¥¼ ì…í˜”ìŠµë‹ˆë‹¤!');

      if (this.currentGhost.hp <=0) {
        this.score += this.currentGhost.points;
        replier.reply(this.currentGhost.name + 'ì„(ë¥¼) ë¬¼ë¦¬ì³¤ìŠµë‹ˆë‹¤! +' + 
                      this.currentGhost.points + 'ì ');
        this.updateScore();
        if (this.bossSpawned) {
          this.end();
        } else {
          this.spawnGhost();
        }
      } else {
        replier.reply(this.currentGhost.name + 'ì˜ ë‚¨ì€ HP:' + 
                      this.currentGhost.hp);
      }
   },

   shop : function() {
     var weapons = [
       {name:"ë‚˜ë¬´ ë§‰ëŒ€ê¸°" , damage :2 , price :50},
       {name:"ì€ ë‹¨ê²€" , damage :3 , price :100},
       {name:"ë§ˆë²• ì§€íŒ¡ì´" , damage :5 , price :200},
       {name:"ì„±ìŠ¤ëŸ¬ìš´ ê²€" , damage :7 , price :300},
       {name:"ìœ ë ¹ ì‚¬ëƒ¥ê¾¼ì˜ ì´" , damage :10 , price :500},
       {name:"ë“œë˜ê³¤ ìŠ¬ë ˆì´ì–´" , damage :15 , price :750},
       {name:"ì´ˆì›”ì˜ ë¬´ê¸°" , damage :20 , price :1000}
      ];

      var shopMenu = 'ìƒì  ë©”ë‰´:\n';
      for (var i=0; i < weapons.length; i++) {
        shopMenu += (i+1) + '.'+ weapons[i].name +
                    '(ë°ë¯¸ì§€:' + weapons[i].damage +
                    ', ê°€ê²©:' + weapons[i].price +
                    ')\n';
      }
      replier.reply(shopMenu +
                    '\nêµ¬ë§¤í•˜ë ¤ë©´ '!êµ¬ë§¤ [ë²ˆí˜¸]'ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');

      return weapons;
   },

   buyWeapon : function(index, weapons) {
      var selectedWeapon = weapons[index -1];
      if (this.score >= selectedWeapon.price) {
        this.score -= selectedWeapon.price;
        this.weapon = selectedWeapon;
        replier.reply(selectedWeapon.name +
                      'ì„(ë¥¼) êµ¬ë§¤í–ˆìŠµë‹ˆë‹¤!');
        this.updateScore();
      } else {
        replier.reply('ì ìˆ˜ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!');
      }
   }
};

function response(room, msg, sender, isGroupChat, replier) {
   if (msg === "!í• ë¡œìœˆ ê²Œì„ ì‹œì‘") {
      Game.start();
   } else if (msg === "!ê³µê²©" && Game.timeLeft >0) {
      Game.attack();
   } else if (msg === "!ìƒì ") {
      var weapons = Game.shop();
      Game.lastShopWeapons = weapons;
   } else if (msg.startsWith("!êµ¬ë§¤ ") && Game.lastShopWeapons) {
      var index = parseInt(msg.split(" ")[1]);
      if (index >0 && index <= Game.lastShopWeapons.length) {
         Game.buyWeapon(index, Game.lastShopWeapons);
      } else {
         replier.reply('ì˜¬ë°”ë¥¸ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      }
   }
}
